<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stream Deck Pi Manager</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    {% raw %}
    <div id="app">
      <header>
        <h1>ðŸŽ® Stream Deck Pi Manager</h1>
        <div class="device-info" v-if="deviceInfo">
          <span
            class="badge"
            :class="deviceInfo.connected ? 'badge-success' : 'badge-danger'"
          >
            {{ deviceInfo.connected ? 'Connected' : 'Disconnected' }}
          </span>
          <span>{{ deviceInfo.type }}</span>
          <span>Serial: {{ deviceInfo.serial }}</span>
        </div>
      </header>

      <main>
        <div class="controls">
          <div class="control-group">
            <label for="brightness">Brightness</label>
            <input
              id="brightness"
              type="range"
              min="0"
              max="100"
              v-model="brightness"
              @input="updateBrightness"
            />
            <span>{{ brightness }}%</span>
          </div>

          <div class="control-group">
            <label>Page</label>
            <select
              v-model="currentPageId"
              @change="switchPage(currentPageId)"
              style="margin-right: 5px; padding: 5px"
            >
              <option v-for="page in pages" :key="page.id" :value="page.id">
                {{ page.title }}
              </option>
            </select>
            <button
              @click="showPageModal = true"
              class="btn btn-sm"
              title="Add Page"
            >
              +
            </button>
            <button
              @click="deletePage(currentPageId)"
              class="btn btn-sm btn-danger"
              :disabled="pages.length <= 1"
              title="Delete Page"
            >
              -
            </button>
          </div>

          <button @click="reconnectDevice" class="btn btn-secondary">
            Reconnect Device
          </button>

          <button @click="loadButtons" class="btn btn-primary">Refresh</button>
        </div>

        <div class="streamdeck-grid" v-if="deviceInfo">
          <div
            v-for="button in buttons"
            :key="button.key"
            class="button-slot"
            :class="{ 'button-active': button.enabled, 'button-inactive': !button.enabled }"
            @click="editButton(button)"
          >
            <div class="button-key">{{ button.key }}</div>
            <div class="button-label">{{ button.label || 'Empty' }}</div>
            <div
              class="button-plugin"
              v-if="button.action && button.action.plugin_id"
            >
              {{ getPluginName(button.action.plugin_id) }}
            </div>
          </div>
        </div>

        <!-- Button Editor Modal -->
        <div class="modal" v-if="editingButton" @click.self="closeEditor">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Edit Button {{ editingButton.key }}</h2>
              <button class="close" @click="closeEditor">&times;</button>
            </div>

            <div class="modal-body">
              <div class="form-group">
                <label>Label</label>
                <input
                  type="text"
                  v-model="editingButton.label"
                  class="form-control"
                />
              </div>

              <div class="form-group">
                <label>Icon (Emoji or Character)</label>
                <input
                  type="text"
                  v-model="editingButton.icon"
                  class="form-control"
                  maxlength="5"
                  placeholder="e.g. ðŸ  or A"
                />
                <small class="form-text text-muted"
                  >Enter a single emoji or character.</small
                >
              </div>

              <div class="form-group">
                <label>Plugin</label>
                <select
                  v-model="editingButton.selectedPlugin"
                  class="form-control"
                  @change="onPluginChange"
                >
                  <option value="">None</option>
                  <optgroup
                    v-for="(pluginGroup, category) in pluginsByCategory"
                    :label="category"
                    :key="category"
                  >
                    <option
                      v-for="plugin in pluginGroup"
                      :value="plugin.id"
                      :key="plugin.id"
                    >
                      {{ plugin.name }}
                    </option>
                  </optgroup>
                </select>
                <small v-if="selectedPluginInfo"
                  >{{ selectedPluginInfo.description }}</small
                >
              </div>

              <div
                class="form-group"
                v-if="selectedPluginInfo && selectedPluginInfo.config_schema.properties"
              >
                <h3>Plugin Configuration</h3>
                <div
                  v-for="(prop, key) in selectedPluginInfo.config_schema.properties"
                  :key="key"
                >
                  <label>{{ key }}</label>
                  <input
                    v-if="prop.type === 'string'"
                    type="text"
                    v-model="editingButton.config[key]"
                    :placeholder="prop.default || ''"
                    class="form-control"
                  />
                  <input
                    v-else-if="prop.type === 'integer'"
                    type="number"
                    v-model.number="editingButton.config[key]"
                    class="form-control"
                  />
                  <small>{{ prop.description }}</small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Font Size</label>
                  <input
                    type="number"
                    v-model.number="editingButton.font_size"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label>
                    <input type="checkbox" v-model="editingButton.enabled" />
                    Enabled
                  </label>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button @click="testButton" class="btn btn-secondary">
                Test
              </button>
              <button @click="clearButton" class="btn btn-danger">Clear</button>
              <button @click="saveButton" class="btn btn-primary">Save</button>
            </div>
          </div>
        </div>

        <!-- Page Modal -->
        <div
          class="modal"
          v-if="showPageModal"
          @click.self="showPageModal = false"
        >
          <div class="modal-content">
            <div class="modal-header">
              <h2>New Page</h2>
              <button class="close" @click="showPageModal = false">
                &times;
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Page Title</label>
                <input
                  type="text"
                  v-model="newPageTitle"
                  class="form-control"
                  @keyup.enter="createPage"
                  placeholder="Enter page title"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button @click="createPage" class="btn btn-primary">
                Create Page
              </button>
            </div>
          </div>
        </div>
      </main>

      <footer>
        <p>Stream Deck Pi Manager v1.0.0</p>
      </footer>
    </div>
    {% endraw %}

    <script src="/static/js/app.js"></script>
  </body>
</html>
